{% comment %}
  Why Us Accordion Section - Fixed Auto-Scroll Issue
  Usage: Add via theme customizer
{% endcomment %}

<div class="why-us-section" style="background-color: {{ section.settings.background_color }}; padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px 0;">
  <div class="page-width">
    
    {% if section.settings.subtitle != blank %}
      <span class="why-us-subtitle">{{ section.settings.subtitle }}</span>
    {% endif %}
    
    {% if section.settings.title != blank %}
      <h2 class="why-us-title">{{ section.settings.title }}</h2>
    {% endif %}
    
    {% if section.settings.description != blank %}
      <p class="why-us-description">{{ section.settings.description }}</p>
    {% endif %}

    <div class="why-us-wrapper">
      <div class="why-us-container" id="whyUsContainer-{{ section.id }}">
        {% for block in section.blocks %}
          <div class="feature-card {% if forloop.first %}active{% endif %}" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
            <div class="progress-bar"></div>
            
            <div class="card-inner">
              <div class="icon-wrapper">
                <div class="icon-circle">
                  {% case block.settings.icon %}
                    {% when 'natural' %}
                      <svg fill="none" stroke-width="1.5" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>
                    {% when 'lab' %}
                      <svg fill="none" stroke-width="1.5" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"/></svg>
                    {% when 'ancient' %}
                      <svg fill="none" stroke-width="1.5" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
                    {% when 'delivery' %}
                      <svg fill="none" stroke-width="1.5" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12"/></svg>
                    {% when 'eco' %}
                      <svg fill="none" stroke-width="1.5" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>
                    {% when 'holistic' %}
                      <svg fill="none" stroke-width="1.5" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/></svg>
                  {% endcase %}
                </div>
              </div>

              <div class="vertical-title-wrapper">
                <span class="vertical-title">{{ block.settings.title }}</span>
              </div>

              <div class="expanded-content">
                <div class="content-inner">
                  <div class="feature-number">0{{ forloop.index }}</div>
                  <h3 class="feature-title">{{ block.settings.title }}</h3>
                  <p class="feature-description">{{ block.settings.description }}</p>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="nav-dots" id="navDots-{{ section.id }}">
      {% for block in section.blocks %}
        <div class="nav-dot {% if forloop.first %}active{% endif %}" onclick="activateCard{{ section.id | replace: '-', '' }}({{ forloop.index0 }}, true)"></div>
      {% endfor %}
    </div>

    <div class="scroll-hint">
      <svg class="scroll-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
      <span>Click cards to explore</span>
    </div>
  </div>
</div>

<style>
  .why-us-section {
    font-family: var(--font-body-family), 'Inter', sans-serif;
    overflow: hidden;
  }
  
  .page-width {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .why-us-subtitle {
    display: block;
    text-align: center;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.3em;
    color: {{ section.settings.accent_color }};
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .why-us-title {
    font-family: var(--font-heading-family), 'Cormorant Garamond', serif;
    text-align: center;
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 700;
    color: {{ section.settings.heading_color }};
    margin-bottom: 1rem;
    line-height: 1.1;
  }

  .why-us-description {
    text-align: center;
    font-size: 16px;
    color: {{ section.settings.text_color }};
    max-width: 600px;
    margin: 0 auto 3rem;
    line-height: 1.6;
    opacity: 0.9;
  }

  /* Center the entire container */
  .why-us-wrapper {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .why-us-container {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    padding: 2rem 1rem;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: {{ section.settings.accent_color }} #F5EDE4;
    justify-content: flex-start;
    max-width: 100%;
  }

  .why-us-container::-webkit-scrollbar {
    height: 6px;
  }

  .why-us-container::-webkit-scrollbar-track {
    background: #F5EDE4;
    border-radius: 10px;
  }

  .why-us-container::-webkit-scrollbar-thumb {
    background: {{ section.settings.accent_color }};
    border-radius: 10px;
  }

  .feature-card {
    flex: 0 0 auto;
    width: 90px;
    min-height: 350px;
    background: linear-gradient(180deg, #F5EDE4 0%, #FDF8F3 100%);
    border: 1px solid #E8D5B7;
    border-radius: 24px;
    cursor: pointer;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    scroll-snap-align: center;
    position: relative;
    overflow: hidden;
  }

  .feature-card.active {
    width: 380px;
    background: white;
    box-shadow: 0 25px 50px -12px rgba(61, 35, 20, 0.15);
  }

  .card-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    padding: 2rem 0;
    position: relative;
  }

  .icon-wrapper {
    flex-shrink: 0;
    margin-bottom: 1.5rem;
  }

  .icon-circle {
    width: 56px;
    height: 56px;
    background: #FDF8F3;
    border: 2px solid #E8D5B7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.5s ease;
  }

  .icon-circle svg {
    width: 24px;
    height: 24px;
    color: {{ section.settings.heading_color }};
    transition: all 0.5s ease;
  }

  .feature-card.active .icon-circle {
    width: 90px;
    height: 90px;
    background: {{ section.settings.accent_color }};
    border-color: {{ section.settings.accent_color }};
    box-shadow: 0 10px 30px {{ section.settings.accent_color | color_modify: 'alpha', 0.3 }};
  }

  .feature-card.active .icon-circle svg {
    width: 36px;
    height: 36px;
    color: white;
  }

  .vertical-title-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.3s;
  }

  .vertical-title {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    font-family: var(--font-heading-family), 'Cormorant Garamond', serif;
    font-size: 2rem;
    font-weight: 600;
    color: {{ section.settings.heading_color }};
    letter-spacing: 0.05em;
    white-space: nowrap;
    display: block;
  }

  .feature-card.active .vertical-title-wrapper {
    opacity: 0;
    position: absolute;
    pointer-events: none;
  }

  /* FIXED: Expanded content now displays properly */
  .expanded-content {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: anchor-center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    padding: 2rem;
  }

  .feature-card.active .expanded-content {
    opacity: 1;
    pointer-events: all;
  }

  .content-inner {
    text-align: center;
    width: 100%;
    padding-bottom: 1rem;
  }

  .feature-number {
    font-family: var(--font-heading-family), 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    color: {{ section.settings.accent_color }};
    letter-spacing: 0.2em;
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    font-weight: 600;
  }

  .feature-title {
    font-family: var(--font-heading-family), 'Cormorant Garamond', serif;
    font-size: 2.5rem;
    font-weight: 700;
    color: {{ section.settings.heading_color }};
    margin-bottom: 1rem;
    line-height: 1.2;
  }

  .feature-description {
    font-size: 1.5rem;
    color: {{ section.settings.text_color }};
    line-height: 1.7;
    margin: 0;
    opacity: 0.9;
  }

  .progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: {{ section.settings.accent_color }};
    width: 0%;
    transition: width 0.3s;
    z-index: 10;
  }

  .feature-card.active .progress-bar {
    width: 100%;
    transition: width 3s linear;
  }

  .nav-dots {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 2rem;
  }

  .nav-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #E8D5B7;
    cursor: pointer;
    transition: all 0.3s;
  }

  .nav-dot.active {
    background: {{ section.settings.accent_color }};
    transform: scale(1.2);
  }

  .scroll-hint {
    text-align: center;
    margin-top: 1.5rem;
    color: {{ section.settings.text_color }};
    font-size: 0.875rem;
    opacity: 0.6;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .scroll-icon {
    width: 1rem;
    height: 1rem;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.6; transform: translateX(0); }
    50% { opacity: 1; transform: translateX(3px); }
  }

  /* Hover effects for non-active cards */
  .feature-card:not(.active):hover {
    background: white;
    border-color: {{ section.settings.accent_color }};
    transform: translateY(-2px);
  }

  .feature-card:not(.active):hover .icon-circle {
    border-color: {{ section.settings.accent_color }};
    transform: scale(1.05);
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .page-width {
      padding: 0 1rem;
    }
    
    .feature-card {
      width: 70px;
      min-height: 300px;
    }
    
    .feature-card.active {
      width: 300px;
    }
    
    .why-us-title {
      font-size: 1.75rem;
    }
    
    .icon-circle {
      width: 48px;
      height: 48px;
    }
    
    .icon-circle svg {
      width: 20px;
      height: 20px;
    }
    
    .feature-card.active .icon-circle {
      width: 70px;
      height: 70px;
    }
    
    .feature-title {
      font-size: 1.5rem;
    }
    
    .feature-description {
      font-size: 0.875rem;
    }
  }

  @media (min-width: 1200px) {
    .why-us-container {
      justify-content: center;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var sectionId = '{{ section.id | replace: '-', '' }}';
    var currentIndex = 0;
    var cards = document.querySelectorAll('#whyUsContainer-{{ section.id }} .feature-card');
    var dots = document.querySelectorAll('#navDots-{{ section.id }} .nav-dot');
    var container = document.getElementById('whyUsContainer-{{ section.id }}');
    var autoPlayInterval;
    var isUserInteracting = false;

    // Function to activate card - scrollOnly when explicitly requested
    window['activateCard' + sectionId] = function(index, shouldScroll) {
      shouldScroll = shouldScroll || false;
      currentIndex = index;
      
      cards.forEach(function(card, i) {
        if (i === index) {
          card.classList.add('active');
          // Only scroll if explicitly requested (user click) or if in viewport
          if (shouldScroll && isElementInViewport(container)) {
            setTimeout(function() {
              card.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }, 100);
          }
        } else {
          card.classList.remove('active');
        }
      });

      dots.forEach(function(dot, i) {
        dot.classList.toggle('active', i === index);
      });

      // Reset and animate progress bar
      cards.forEach(function(card) {
        var pb = card.querySelector('.progress-bar');
        if (pb) pb.style.width = '0%';
      });
      
      var activePb = cards[index].querySelector('.progress-bar');
      if (activePb) {
        setTimeout(function() {
          activePb.style.width = '100%';
        }, 50);
      }
    };

    // Check if element is in viewport
    function isElementInViewport(el) {
      if (!el) return false;
      var rect = el.getBoundingClientRect();
      return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
      );
    }

    function startAutoPlay() {
      // Only autoplay if section is visible
      if (!isElementInViewport(container)) return;
      
      autoPlayInterval = setInterval(function() {
        if (!isUserInteracting && isElementInViewport(container)) {
          var nextIndex = (currentIndex + 1) % cards.length;
          window['activateCard' + sectionId](nextIndex, false); // Don't scroll on autoplay
        }
      }, 4000);
    }

    function stopAutoPlay() {
      clearInterval(autoPlayInterval);
    }

    // Event listeners
    if (container) {
      container.addEventListener('mouseenter', function() {
        isUserInteracting = true;
        stopAutoPlay();
      });
      
      container.addEventListener('mouseleave', function() {
        isUserInteracting = false;
        startAutoPlay();
      });
      
      // Handle manual scroll
      var isScrolling;
      container.addEventListener('scroll', function() {
        window.clearTimeout(isScrolling);
        isScrolling = setTimeout(function() {
          if (isUserInteracting) {
            var scrollLeft = container.scrollLeft;
            var cardWidth = cards[0].offsetWidth + 16;
            var newIndex = Math.round(scrollLeft / cardWidth);
            if (newIndex !== currentIndex && newIndex >= 0 && newIndex < cards.length) {
              window['activateCard' + sectionId](newIndex, false);
            }
          }
        }, 150);
      });
    }

    // Click on cards - only scroll when user explicitly clicks
    cards.forEach(function(card, index) {
      card.addEventListener('click', function() {
        isUserInteracting = true;
        window['activateCard' + sectionId](index, true); // Scroll on click
        setTimeout(function() {
          isUserInteracting = false;
        }, 1000);
      });
    });

    // Intersection Observer to only autoplay when visible
    if ('IntersectionObserver' in window) {
      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            startAutoPlay();
          } else {
            stopAutoPlay();
          }
        });
      }, { threshold: 0.5 });
      
      if (container) {
        observer.observe(container);
      }
    } else {
      // Fallback for older browsers
      startAutoPlay();
    }

    // Initialize first card progress bar without scrolling
    setTimeout(function() {
      var firstCard = cards[0];
      if (firstCard) {
        var pb = firstCard.querySelector('.progress-bar');
        if (pb) pb.style.width = '100%';
      }
    }, 500);
  });
</script>

{% schema %}
{
  "name": "Why Us Accordion",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "subtitle",
      "default": "Why Choose Us",
      "label": "Subtitle"
    },
    {
      "type": "text",
      "id": "title",
      "default": "The Sohamayur Difference",
      "label": "Title"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "We bring you the finest Ayurvedic formulations backed by science and rooted in tradition. Here is what sets us apart.",
      "label": "Description"
    },
    {
      "type": "color",
      "id": "background_color",
      "default": "#FDF8F3",
      "label": "Background Color"
    },
    {
      "type": "color",
      "id": "heading_color",
      "default": "#3D2314",
      "label": "Heading Color"
    },
    {
      "type": "color",
      "id": "text_color",
      "default": "#6B5B4F",
      "label": "Text Color"
    },
    {
      "type": "color",
      "id": "accent_color",
      "default": "#C9A227",
      "label": "Accent Color"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 64,
      "label": "Top Padding"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 64,
      "label": "Bottom Padding"
    }
  ],
  "blocks": [
    {
      "type": "feature",
      "name": "Feature",
      "settings": [
        {
          "type": "select",
          "id": "icon",
          "options": [
            { "value": "natural", "label": "Natural/Leaf" },
            { "value": "lab", "label": "Lab Tested/Shield" },
            { "value": "ancient", "label": "Ancient Recipes/Book" },
            { "value": "delivery", "label": "Fast Delivery/Truck" },
            { "value": "eco", "label": "Eco-Friendly/Recycle" },
            { "value": "holistic", "label": "Holistic Care/Heart" }
          ],
          "default": "natural",
          "label": "Icon"
        },
        {
          "type": "text",
          "id": "title",
          "default": "100% Natural",
          "label": "Title"
        },
        {
          "type": "textarea",
          "id": "description",
          "default": "Pure herbs and botanicals sourced directly from organic farms.",
          "label": "Description"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Why Us Accordion",
      "blocks": [
        { "type": "feature", "settings": { "icon": "natural", "title": "100% Natural", "description": "Pure herbs and botanicals sourced directly from organic farms." } },
        { "type": "feature", "settings": { "icon": "lab", "title": "Lab Tested", "description": "Every batch is rigorously tested for purity and potency." } },
        { "type": "feature", "settings": { "icon": "ancient", "title": "Ancient Recipes", "description": "Formulations rooted in 5,000 years of Ayurvedic tradition." } },
        { "type": "feature", "settings": { "icon": "delivery", "title": "Fast Delivery", "description": "Free shipping on orders above $50, delivered in 3-5 days." } },
        { "type": "feature", "settings": { "icon": "eco", "title": "Eco-Friendly", "description": "Sustainable packaging and cruelty-free practices throughout." } },
        { "type": "feature", "settings": { "icon": "holistic", "title": "Holistic Care", "description": "Formulated to balance your body, mind, and spirit naturally." } }
      ]
    }
  ]
}
{% endschema %}